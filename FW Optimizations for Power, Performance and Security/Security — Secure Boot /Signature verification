/* verify_image.c - simplified RSA verify using mbedtls */
#include "mbedtls/rsa.h"
#include "mbedtls/pk.h"
#include "mbedtls/sha256.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// public_key_pem: stored in read-only area
int verify_signature(const unsigned char *image, size_t image_len,
                     const unsigned char *sig, size_t sig_len,
                     const char *public_key_pem) {
    int ret;
    mbedtls_pk_context pk;
    unsigned char hash[32];
    mbedtls_pk_init(&pk);

    ret = mbedtls_pk_parse_public_key(&pk, (const unsigned char*)public_key_pem, strlen(public_key_pem) + 1);
    if (ret) { printf("pk parse failed %d\n", ret); goto exit; }

    mbedtls_sha256(image, image_len, hash, 0);
    ret = mbedtls_pk_verify(&pk, MBEDTLS_MD_SHA256, hash, sizeof(hash), sig, sig_len);
    if (ret) { printf("signature verify failed %d\n", ret); }

exit:
    mbedtls_pk_free(&pk);
    return ret;
}
